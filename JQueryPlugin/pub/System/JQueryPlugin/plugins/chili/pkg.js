!function(e){ChiliBook={version:"2.2",automatic:!0,automaticSelector:"code",lineNumbers:!1,codeLanguage:function(r){var t=e(r).attr("class");return t||""},recipeLoading:!0,recipeFolder:"",replaceSpace:"&#160;",replaceTab:"&#160;&#160;&#160;&#160;",replaceNewLine:"&#160;<br/>",selectionStyle:["position:absolute; z-index:3000; overflow:scroll;","width:16em;","height:9em;","border:1px solid gray;","padding:15px;","background-color:yellow;"].join(" "),defaultReplacement:'<span class="$0">$$</span>',recipes:{},queue:{},unique:function(){return(new Date).valueOf()}},e.fn.chili=function(r){var t=e.extend({},ChiliBook,r||{});function n(r,i,c){function l(e,r,n){var i=e[r][n],a="string"==typeof i._match?i._match:i._match.source;return{recipe:e,blockName:r,stepName:n,exp:"("+a+")",length:1+(a.replace(/\\./g,"%").replace(/\[.*?\]/g,"%").match(/\((?!\?)/g)||[]).length,replacement:i._replace?i._replace:t.defaultReplacement}}function o(e){for(var r=1,t=[],n=0;n<e.length;n++){var a=e[n].exp;a=a.replace(/\\\\|\\(\d+)/g,(function(e,t){return t?"\\"+(r+1+parseInt(t,10)):e})),t.push(a),r+=e[n].length}var c="(?:"+t.join("|")+")";return c="((?:\\s|\\S)*?)"+c+"|((?:\\s|\\S)+)",new RegExp(c,i._case?"g":"gi")}function u(e){return e=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;")}(e),h&&(e=function(e){return e.replace(/ +/g,(function(e){return e.replace(/ /g,h)}))}(e)),e}function s(r,i,c){if(!i)return u(r);var p=i.split("/"),h="",g="",d="";switch(p.length){case 1:h=p[0];break;case 2:h=p[0],g=p[1];break;case 3:h=p[0],g=p[1],d=p[2];break;default:return u(r)}function v(e){var r=a(e),n=t.recipes[r];if(!n)throw{msg:"recipe not available"};return n}try{var m;if(""!=d)return m=""==h?c.recipe:v(h),""==g&&(g=c.blockName),g in m&&d in m[g]?function(e,r,n,i){t.replaceSpace;var a=[l(r,n,i)],c=e.replace(o(a),(function(){return f.apply({steps:a},arguments)}));return c}(r,m,g,d):u(r);if(""!=g)return g in(m=""==h?c.recipe:v(h))?function(e,r,t){return n(e,r,t)}(r,m,g):u(r);if(""!=h)return function(e,r){return n(e,r)}(r,m=v(h))}catch(n){if(n.msg&&"recipe not available"==n.msg){var b="chili_"+t.unique();if(t.recipeLoading){var w=a(h);if(t.queue[w])t.queue[w].push({cue:b,subject:r,module:i,context:c});else try{t.queue[w]=[{cue:b,subject:r,module:i,context:c}],e.ajax({url:w,dataType:"text",success:function(r){t.recipes[w]=window.eval("(function() { var recipe = "+r+"; return recipe; }())");for(var n=t.queue[w],i=0,a=n.length;i<a;i++){var c=s(n[i].subject,n[i].module,n[i].context);t.replaceTab&&(c=c.replace(/\t/g,t.replaceTab)),t.replaceNewLine&&(c=c.replace(/\n/g,t.replaceNewLine)),e("#"+n[i].cue).replaceWith(c)}}})}catch(e){alert("the recipe for '"+h+"' was not found in '"+w+"'")}return'<span id="'+b+'">'+u(r)+"</span>"}return u(r)}return u(r)}}function p(e,r){return r.replace(/(<span\s+class\s*=\s*(["']))((?:(?!__)\w)+\2\s*>)/gi,"$1"+e+"__$3")}function f(){if(!arguments[0])return"";var e,r=this.steps,t=0,n=2,i=arguments[1],a=arguments[arguments.length-3];if(a)return u(a);for(;e=r[t++];){var c=arguments;if(c[n]){var l="";if("function"==typeof e.replacement){for(var o=[],f=0,h=e.length;f<h;f++)o.push(c[n+f]);o.push(c[c.length-2]),o.push(c[c.length-1]),l=e.replacement.apply({x:function(){return s(arguments[0],arguments[1],{recipe:e.recipe,blockName:e.blockName})}},o)}else l=e.replacement.replace(/(\\\$)|(?:\$\$)|(?:\$(\d+))/g,(function(r,t,i){return t?"$":i?"0"==i?e.stepName:u(c[n+parseInt(i,10)]):u(c[n])}));return l=p(e.recipe._name,l),u(i)+l}n+=e.length}}if(c||(c="_main",function(e){var r=e._name;if(!t.queue[r]){var n=["/* Chili -- "+r+" */"];for(var i in e)if(i.search(/^_(?!main\b)/)<0)for(var a in e[i]){var c=e[i][a];if("_style"in c)if(c._style.constructor==String)n.push("."+r+"__"+a+" { "+c._style+" }");else for(var l in c._style)n.push("."+r+"__"+l+" { "+c._style[l]+" }")}(function(e){if(document.createElement){var r=document.createElement("style");if(r.type="text/css",r.styleSheet)r.styleSheet.cssText=e;else{var t=document.createTextNode(e);r.appendChild(t)}document.getElementsByTagName("head")[0].appendChild(r)}})(n=n.join("\n")),t.queue[r]=!0}}(i)),!(c in i))return u(r);var h=t.replaceSpace,g=function(e,r){var t=[];for(var n in e[r])t.push(l(e,r,n));return t}(i,c),d=o(g),v=r.replace(d,(function(){return f.apply({steps:g},arguments)}));return v}function i(r,i){var a=t.recipes[i];if(a){var l=e(r),o=l.text();if(o){o=o.replace(/\r\n?/g,"\n"),l.parent().is("pre")&&(e.browser.safari||(o=o.replace(/^\n/g,"")));var u=n(o,a);t.replaceTab&&(u=u.replace(/\t/g,t.replaceTab)),t.replaceNewLine&&(u=u.replace(/\n/g,t.replaceNewLine)),r.innerHTML=u,(e.browser.msie||e.browser.mozilla)&&function(r){var t=null;e(r).parents().filter("pre").on("mousedown",(function(){t=this,e.browser.msie?document.selection.empty():window.getSelection().removeAllRanges()})).on("mouseup",(function(r){if(t&&t==this){t=null;var n="";if(e.browser.msie){if(""==(n=document.selection.createRange().htmlText))return;n=function(r){do{var t=ChiliBook.unique()}while(r.indexOf(t)>-1);var n="";if(/<br/i.test(r)||/<li/i.test(r)){/<br/i.test(r)?r=r.replace(/\<br[^>]*?\>/gi,t):/<li/i.test(r)&&(r=r.replace(/<ol[^>]*?>|<\/ol>|<li[^>]*?>/gi,"").replace(/<\/li>/gi,t));var i=e("<pre>").appendTo("body").hide()[0];i.innerHTML=r,n=e(i).text().replace(new RegExp(t,"g"),"\r\n"),e(i).remove()}return n}(n);var i='<textarea style="STYLE">'}else{if(""==(n=window.getSelection().toString()))return;n=n.replace(/\r/g,"").replace(/^# ?/g,"").replace(/\n# ?/g,"\n");i='<pre style="STYLE">'}var a=e(i.replace(/\bSTYLE\b/,ChiliBook.selectionStyle)).appendTo("body").text(n).attr("id","chili_selection").click((function(){e(this).remove()})),c=r.pageY-Math.round(a.height()/2)+"px",l=r.pageX-Math.round(a.width()/2)+"px";if(a.css({top:c,left:l}),e.browser.msie)a[0].focus(),a[0].select();else{var o=window.getSelection();o.removeAllRanges();var u=document.createRange();u.selectNodeContents(a[0]),o.addRange(u)}}}))}(r);var s=l.parent(),p=s.attr("class"),f=/ln-(\d+)-([\w][\w\-]*)|ln-(\d+)|ln-/.exec(p);if(f){c(r);var h=0;if(f[1]){h=parseInt(f[1],10);var g=e(".ln-"+f[1]+"-"+f[2]),d=g.index(s[0]);g.slice(0,d).each((function(){h+=e(this).find("li").length}))}else h=f[3]?parseInt(f[3],10):1;l.find("ol")[0].start=h,e("body").width(e("body").width()-1).width(e("body").width()+1)}else t.lineNumbers&&c(r)}}}function a(e){return t.recipeFolder+e+".js"}function c(r){function n(e,r,t,n){var i=n?"</span>":"",a="";return e?a="<li>"+n+r+i+"</li>":t&&(a="<li>"+n+t+i+"</li>"),a}var i=e(r).html(),a=/<br>/.test(i)?"<br>":"<BR>",c="<li>"+t.replaceSpace+"</li>",l=i.replace(/(<span [^>]+>)((?:(?:&nbsp;|\xA0)<br>)+)(.*?)(<\/span>)/gi,"$2$1$3$4").replace(/(.*?)(<span .*?>)(.*?)(?:<\/span>(?:&nbsp;|\xA0)<br>|<\/span>)/gi,(function(e,r,t,i){if(/<br>/i.test(i)){var c=r.split(a),l=c.pop();return((r=c.join(a))?r+a:"")+(l+i).replace(/((.*?)(?:&nbsp;|\xA0)<br>)|(.*)/gi,(function(e,r,i,a){return n(r,i,a,t)}))}return e})).replace(/(<li>.*?<\/li>)|((.*?)(?:&nbsp;|\xA0)<br>)|(.+)/gi,(function(e,r,t,i,a){var c=function(e,r,t,i){return i||n(e,r,t,"")}(t,i,a,r);return c})).replace(/<li><\/li>/gi,c);r.innerHTML="<ol>"+l+"</ol>"}return this.each((function(){var r=e(this);r.trigger("chili.before_coloring"),function(r){var n=t.codeLanguage(r);if(""!=n){var c=a(n);if(t.recipeLoading){if(t.queue[c])t.queue[c].push(r);else try{t.queue[c]=[r],e.ajax({url:c,dataType:"text",success:function(e){t.recipes[c]=window.eval("(function() { var recipe = "+e+"; return recipe; }())");for(var r=t.queue[c],n=0,a=r.length;n<a;n++)i(r[n],c)}})}catch(e){alert("the recipe for '"+n+"' was not found in '"+c+"'")}i(r,c)}else i(r,c)}}(this),r.trigger("chili.after_coloring")})),this}}(jQuery),jQuery((function(e){ChiliBook.codeLanguage=function(e){var r=jQuery(e).attr("class")||"",t=/^.*\b(bash|cplusplus|csharp|css|delphi|html|java|js|lotusscript|php-f|php|recipes|sql|tml|xml|autolisp|ini)\b.*$/;return r&&t.test(r)?r.replace(t,"$1"):""},ChiliBook.recipeFolder=foswiki.getPubUrlPath(foswiki.getPreference("SYSTEMWEB"),"JQueryPlugin")+"/plugins/chili/recipes/",ChiliBook.automaticSelector="pre",ChiliBook.automatic&&e(ChiliBook.automaticSelector).livequery((function(){e(this).chili()}))}));
