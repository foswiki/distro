(function(factory,global){var $=global.jQuery;if(typeof exports==="object"){module.exports=$?factory(global,$):function($){return factory(global,$)}}else if(typeof define==="function"&&define.amd){define(["jquery","./jsrender","./jquery.observable"],function($,jsr,jso){return factory(global,$,jsr,jso)})}else{factory(global,false)}})(function(global,$,jsr,jso){"use strict";var setGlobals=$===false;jsr=jsr||setGlobals&&global.jsrender;$=$||global.jQuery;var versionNumber="v0.9.90",requiresStr="JsViews requires ";if(!$||!$.fn){throw requiresStr+"jQuery"}if(jsr&&!jsr.fn){jsr.views.sub._jq($)}var $observe,$observable,$isArray=$.isArray,$views=$.views;if(!$views||!$views.map){throw requiresStr+"JsRender"}var document=global.document,$viewsSettings=$views.settings,$sub=$views.sub,$subSettings=$sub.settings,$extend=$sub.extend,$isFunction=$.isFunction,$expando=$.expando,$converters=$views.converters,$tags=$views.tags,$subSettingsAdvanced=$subSettings.advanced,propertyChangeStr=$sub.propChng=$sub.propChng||"propertyChange",arrayChangeStr=$sub.arrChng=$sub.arrChng||"arrayChange",HTML="html",_ocp="_ocp",syntaxError=$sub.syntaxErr,rFirstElem=/<(?!script)(\w+)[>\s]/,error=$sub._er,onRenderError=$sub._err,delimOpenChar0,delimOpenChar1,delimCloseChar0,delimCloseChar1,linkChar,topView,rEscapeQuotes=/['"\\]/g;if($.link){return $}$subSettings.trigger=true;var activeBody,rTagDatalink,$view,$viewsLinkAttr,linkViewsSel,wrapMap,viewStore,oldAdvSet,useInput,jsvAttrStr="data-jsv",elementChangeStr="change.jsv",onBeforeChangeStr="onBeforeChange",onAfterChangeStr="onAfterChange",onAfterCreateStr="onAfterCreate",CHECKED="checked",CHECKBOX="checkbox",RADIO="radio",NONE="none",VALUE="value",SCRIPT="SCRIPT",TRUE="true",closeScript='"></script>',openScript='<script type="jsv',deferAttr=jsvAttrStr+"-df",bindElsSel="script,["+jsvAttrStr+"]",fnSetters={value:"val",input:"val",html:HTML,text:"text"},valueBinding={from:VALUE,to:VALUE},isCleanCall=0,oldCleanData=$.cleanData,oldJsvDelimiters=$viewsSettings.delimiters,safeFragment=document.createDocumentFragment(),qsa=document.querySelector,elContent={ol:1,ul:1,table:1,tbody:1,thead:1,tfoot:1,tr:1,colgroup:1,dl:1,select:1,optgroup:1,svg:1,svg_ns:1},badParent={tr:"table"},voidElems={br:1,img:1,input:1,hr:1,area:1,base:1,col:1,link:1,meta:1,command:1,embed:1,keygen:1,param:1,source:1,track:1,wbr:1},displayStyles={},bindingStore={},bindingKey=1,rViewPath=/^#(view\.?)?/,rConvertMarkers=/((\/>)|<\/(\w+)>|)(\s*)([#\/]\d+(?:_|(\^)))`(\s*)(<\w+(?=[\s\/>]))?|\s*(?:(<\w+(?=[\s\/>]))|<\/(\w+)>(\s*)|(\/>)\s*|(>)|$)/g,rOpenViewMarkers=/(#)()(\d+)(_)/g,rOpenMarkers=/(#)()(\d+)([_^])/g,rViewMarkers=/(?:(#)|(\/))(\d+)(_)/g,rOpenTagMarkers=/(#)()(\d+)(\^)/g,rMarkerTokens=/(?:(#)|(\/))(\d+)([_^])([-+@\d]+)?/g,rSplitBindings=/&(\d+)\+?/g,getComputedStyle=global.getComputedStyle;$observable=$.observable;if(!$observable){throw requiresStr+"JsObservable"}$observe=$observable.observe;function updateValues(sourceValues,tagElse,bindId,ev){var linkCtx,cvtBack,cnvtName,target,view,binding,sourceValue,origVals,sourceElem,sourceEl,oldLinkCtx,tos,to,tcpTag,exprOb,contextCb,l,tag;if(bindId&&bindId._tgId){tag=bindId;bindId=tag._tgId}if(binding=bindingStore[bindId]){if(tos=binding.to){tos=tos[tagElse||0];linkCtx=binding.linkCtx;sourceElem=linkCtx.elem;view=linkCtx.view;tag=linkCtx.tag;if(!tag&&tos._cxp){tag=tos._cxp.path!==_ocp&&tos._cxp.tag;sourceValue=sourceValues[0];sourceValues=[];sourceValues[tos._cxp.ind]=sourceValue}if(tag){tag._.chg=1;if(cnvtName=tag.convertBack){if($isFunction(cnvtName)){cvtBack=cnvtName}else{cvtBack=view.getRsc("converters",cnvtName)}}}if(sourceElem.nodeName==="SELECT"){if(sourceElem.multiple&&sourceValues[0]===null){sourceValues=[[]]}sourceElem._jsvSel=sourceValues}origVals=sourceValues;if(cvtBack){sourceValues=cvtBack.apply(tag,sourceValues);if(sourceValues===undefined){tos=[]}sourceValues=$isArray(sourceValues)?sourceValues:[sourceValues]}oldLinkCtx=view.linkCtx;view.linkCtx=linkCtx;l=tos.length;while(l--){if(to=tos[l]){to=to+""===to?[linkCtx.data,to]:to;target=to[0];tcpTag=to.tag;sourceValue=(to[1]===_ocp?origVals:sourceValues)[l];if(sourceValue!==undefined&&(!tag||!tag.onBeforeUpdateVal||tag.onBeforeUpdateVal(ev,{change:"change",data:target,path:to[1],index:l,tagElse:tagElse,value:sourceValue})!==false)){if(tcpTag){tcpTag.updateValue(sourceValue,to.ind,to.tagElse,undefined,ev);if(tcpTag.setValue){tcpTag.setValue(sourceValue,to.ind,to.tagElse)}}else if(sourceValue!==undefined&&target){if(tcpTag=ev&&(sourceEl=ev.target)._jsvInd===l&&sourceEl._jsvLkEl){tcpTag.setValue(origVals[l],l,sourceEl._jsvElse)}if(target._cpfn){contextCb=linkCtx._ctxCb;exprOb=target;target=linkCtx.data;if(exprOb._cpCtx){target=exprOb.data;contextCb=exprOb._cpCtx}while(exprOb&&exprOb.sb){target=contextCb(exprOb,target);exprOb=exprOb.sb}}$observable(target).setProperty(to[1],sourceValue)}}}}view.linkCtx=oldLinkCtx}}if(tag){tag._.chg=undefined;return tag}}function onElemChange(ev){var bindId,val,source=ev.target,fromAttr=defaultAttr(source),setter=fnSetters[fromAttr];if(!source._jsvTr||ev.delegateTarget!==activeBody&&ev.target.type!=="number"||ev.type==="input"){val=$isFunction(fromAttr)?fromAttr(source):(source=$(source),setter?source[setter]():source.attr(fromAttr));ev.target._jsvChg=1;rSplitBindings.lastIndex=0;while(bindId=rSplitBindings.exec(ev.target._jsvBnd)){updateValue(val,source._jsvInd,source._jsvElse,bindId[1],ev)}ev.target._jsvChg=undefined}}function onDataLinkedTagChange(ev,eventArgs){var attr,sourceValue,noUpdate,forceUpdate,hasError,onError,bindEarly,linkCtx=this,linkFn=linkCtx.fn,tag=linkCtx.tag,source=linkCtx.data,target=linkCtx.elem,cvt=linkCtx.convert,parentElem=target.parentNode,view=linkCtx.view,oldLinkCtx=view.linkCtx,onEvent=eventArgs&&changeHandler(view,onBeforeChangeStr,tag);view.linkCtx=linkCtx;if(parentElem&&(!onEvent||onEvent.call(tag||linkCtx,ev,eventArgs)!==false)&&(!eventArgs||ev.data.prop==="*"||ev.data.prop===eventArgs.path)){if(eventArgs){linkCtx.eventArgs=eventArgs}if(eventArgs||linkCtx._toLk){linkCtx._toLk=0;if(linkFn._er){try{sourceValue=linkFn(source,view,$sub)}catch(e){hasError=linkFn._er;onError=onRenderError(e,view,new Function("data,view","return "+hasError+";")(source,view));sourceValue=[{props:{},args:[onError],tag:tag}]}}else{sourceValue=linkFn(source,view,$sub)}attr=tag&&tag.attr||linkCtx.attr||defaultAttr(target,true,cvt!==undefined);if(attr===VALUE&&(tag&&tag.parentElem||linkCtx.elem).type===CHECKBOX){attr=CHECKED}if(tag){forceUpdate=hasError||tag._er;sourceValue=sourceValue[0]?sourceValue:[sourceValue];noUpdate=!forceUpdate&&(tag.onUpdate===false||eventArgs&&$isFunction(tag.onUpdate)&&tag.onUpdate(ev,eventArgs,sourceValue)===false);mergeCtxs(tag,sourceValue,forceUpdate);if(tag._.chg&&(attr===HTML||attr===VALUE)||noUpdate||attr===NONE){callAfterLink(tag,ev,eventArgs);if(!tag._.chg){observeAndBind(linkCtx,source,target)}view.linkCtx=oldLinkCtx;if(eventArgs&&(onEvent=changeHandler(view,onAfterChangeStr,tag))){onEvent.call(tag||linkCtx,ev,eventArgs)}return}if(tag.onUnbind){tag.onUnbind(tag.tagCtx,linkCtx,tag.ctx,ev,eventArgs)}sourceValue=tag.tagName===":"?$sub._cnvt(tag.convert,view,sourceValue[0]):$sub._tag(tag,view,view.tmpl,sourceValue,true,onError)}else if(linkFn._tag){cvt=cvt===""?TRUE:cvt;sourceValue=cvt?$sub._cnvt(cvt,view,sourceValue[0]||sourceValue):$sub._tag(linkFn._tag,view,view.tmpl,sourceValue,true,onError);addLinkMethods(tag=linkCtx.tag);attr=linkCtx.attr||attr}if(bindEarly=tag&&!tag.inline&&tag.template){observeAndBind(linkCtx,source,target)}updateContent(sourceValue,linkCtx,attr,tag);linkCtx._noUpd=0;if(tag){tag._er=hasError;callAfterLink(tag,ev,eventArgs)}}if(!bindEarly){observeAndBind(linkCtx,source,target)}if(eventArgs&&(onEvent=changeHandler(view,onAfterChangeStr,tag))){onEvent.call(tag||linkCtx,ev,eventArgs)}view.linkCtx=oldLinkCtx}}function setDefer(elem,value){elem._df=value;elem[(value?"set":"remove")+"Attribute"](deferAttr,"")}function updateContent(sourceValue,linkCtx,attr,tag){var setter,prevNode,nextNode,late,nodesToRemove,useProp,tokens,id,openIndex,closeIndex,testElem,nodeName,cStyle,jsvSel,renders=attr!==NONE&&sourceValue!==undefined&&!linkCtx._noUpd&&!((attr===VALUE||attr===HTML)&&(tag?tag._.chg:linkCtx.elem._jsvChg)),source=linkCtx.data,target=tag&&tag.parentElem||linkCtx.elem,targetParent=target.parentNode,$target=$(target),view=linkCtx.view,targetVal=linkCtx._val,oldLinkCtx=view.linkCtx,change=tag;if(tag){tag._.unlinked=true;tag.parentElem=tag.parentElem||(linkCtx.expr||tag._elCnt)?target:targetParent;prevNode=tag._prv;nextNode=tag._nxt}if(!renders){linkCtx._val=sourceValue;return}if(attr==="visible"){attr="css-display"}if(/^css-/.test(attr)){if(linkCtx.attr==="visible"){cStyle=(target.currentStyle||getComputedStyle.call(global,target,"")).display;if(sourceValue){sourceValue=target._jsvd||cStyle;if(sourceValue===NONE&&!(sourceValue=displayStyles[nodeName=target.nodeName])){testElem=document.createElement(nodeName);document.body.appendChild(testElem);sourceValue=displayStyles[nodeName]=(testElem.currentStyle||getComputedStyle.call(global,testElem,"")).display;document.body.removeChild(testElem)}}else{target._jsvd=cStyle;sourceValue=NONE}}if(change=change||targetVal!==sourceValue){$.style(target,attr.slice(4),sourceValue)}}else if(attr!=="link"){if(/^data-/.test(attr)){$.data(target,attr.slice(5),sourceValue)}else if(/^prop-/.test(attr)){useProp=true;attr=attr.slice(5)}else if(attr===CHECKED){useProp=true;sourceValue=sourceValue&&sourceValue!=="false"}else if(attr===RADIO){useProp=true;attr=CHECKED;sourceValue=target.value===sourceValue}else if(attr==="selected"||attr==="disabled"||attr==="multiple"||attr==="readonly"){sourceValue=sourceValue&&sourceValue!=="false"?attr:null}else if(attr===VALUE&&target.nodeName==="SELECT"){target._jsvSel=$isArray(sourceValue)?sourceValue:""+sourceValue}if(setter=fnSetters[attr]){if(attr===HTML){view.linkCtx=linkCtx;if(tag&&tag.inline){nodesToRemove=tag.nodes(true);if(tag._elCnt){if(prevNode&&prevNode!==nextNode){transferViewTokens(prevNode,nextNode,target,tag._tgId,"^",true)}else if(tokens=target._df){id=tag._tgId+"^";openIndex=tokens.indexOf("#"+id)+1;closeIndex=tokens.indexOf("/"+id);if(openIndex&&closeIndex>0){openIndex+=id.length;if(closeIndex>openIndex){setDefer(target,tokens.slice(0,openIndex)+tokens.slice(closeIndex));disposeTokens(tokens.slice(openIndex,closeIndex))}}}prevNode=prevNode?prevNode.previousSibling:nextNode?nextNode.previousSibling:target.lastChild}$(nodesToRemove).remove();late=view.link(view.data,target,prevNode,nextNode,sourceValue,tag&&{tag:tag._tgId})}else{renders=renders&&targetVal!==sourceValue;if(renders){$target.empty();late=view.link(source,target,prevNode,nextNode,sourceValue,tag&&{tag:tag._tgId})}}view.linkCtx=oldLinkCtx}else{if(change=change||targetVal!==sourceValue){if(attr==="text"&&target.children&&!target.children[0]){if(target.textContent!==undefined){target.textContent=sourceValue}else{target.innerText=sourceValue===null?"":sourceValue}}else{$target[setter](sourceValue)}}if((jsvSel=targetParent._jsvSel)&&(attr===VALUE||!$target.attr(VALUE))){target.selected=$.inArray(""+sourceValue,$isArray(jsvSel)?jsvSel:[jsvSel])>-1}}}else if(change=change||targetVal!==sourceValue){$target[useProp?"prop":"attr"](attr,sourceValue===undefined&&!useProp?null:sourceValue)}}linkCtx._val=sourceValue;lateLink(late);return change}function arrayChangeHandler(ev,eventArgs){var self=this,onBeforeChange=changeHandler(self,onBeforeChangeStr,self.tag),onAfterChange=changeHandler(self,onAfterChangeStr,self.tag);if(!onBeforeChange||onBeforeChange.call(self,ev,eventArgs)!==false){if(eventArgs){var action=eventArgs.change,index=eventArgs.index,items=eventArgs.items;self._.srt=eventArgs.refresh;switch(action){case"insert":self.addViews(index,items);break;case"remove":self.removeViews(index,items.length);break;case"move":self.moveViews(eventArgs.oldIndex,index,items.length);break;case"refresh":self._.srt=undefined;self.fixIndex(0)}}if(onAfterChange){onAfterChange.call(self,ev,eventArgs)}}}function setArrayChangeLink(view){var handler,arrayBinding,type=view.type,data=view.data,bound=view._.bnd;if(!view._.useKey&&bound){if(arrayBinding=view._.bndArr){$([arrayBinding[1]]).off(arrayChangeStr,arrayBinding[0]);view._.bndArr=undefined}if(bound!==!!bound){if(type){bound._.arrVws[view._.id]=view}else{delete bound._.arrVws[view._.id]}}else if(type&&data){handler=function(ev){if(!(ev.data&&ev.data.off)){arrayChangeHandler.apply(view,arguments)}};$([data]).on(arrayChangeStr,handler);view._.bndArr=[handler,data]}}}function defaultAttr(elem,to,linkGetVal){var nodeName=elem.nodeName.toLowerCase(),attr=$subSettingsAdvanced._fe[nodeName]||elem.contentEditable===TRUE&&{to:HTML,from:HTML};return attr?to?nodeName==="input"&&elem.type===RADIO?RADIO:attr.to:attr.from:to?linkGetVal?"text":HTML:""}function renderAndLink(view,index,tmpl,views,data,context,refresh){var html,linkToNode,prevView,nodesToRemove,bindId,parentNode=view.parentElem,prevNode=view._prv,nextNode=view._nxt,elCnt=view._elCnt;if(prevNode&&prevNode.parentNode!==parentNode){error("Missing parentNode")}if(refresh){nodesToRemove=view.nodes();if(elCnt&&prevNode&&prevNode!==nextNode){transferViewTokens(prevNode,nextNode,parentNode,view._.id,"_",true)}view.removeViews(undefined,undefined,true);linkToNode=nextNode;if(elCnt){prevNode=prevNode?prevNode.previousSibling:nextNode?nextNode.previousSibling:parentNode.lastChild}$(nodesToRemove).remove();for(bindId in view._.bnds){removeViewBinding(bindId)}}else{if(index){prevView=views[index-1];if(!prevView){return false}prevNode=prevView._nxt}if(elCnt){linkToNode=prevNode;prevNode=linkToNode?linkToNode.previousSibling:parentNode.lastChild}else{linkToNode=prevNode.nextSibling}}html=tmpl.render(data,context,view._.useKey&&refresh,view,refresh||index,true);lateLink(view.link(data,parentNode,prevNode,linkToNode,html,prevView))}function addBindingMarkers(value,view,tag){var id,end;if(tag){end="^`";addLinkMethods(tag);id=tag._tgId;if(!id){bindingStore[id=bindingKey++]=tag;tag._tgId=""+id}}else{end="_`";viewStore[id=view._.id]=view}return"#"+id+end+(value!=undefined?value:"")+"/"+id+end}function observeAndBind(linkCtx,source,target){var binding,l,k,linkedElem,exprFnDeps,exprOb,prop,propDeps,depends,tagDepends,bindId,linkedElems,tag=linkCtx.tag,cvtBk=linkCtx.convertBack,handler=linkCtx._hdl;source=typeof source==="object"&&source;if(tag){if(depends=tag.convert){depends=depends===TRUE?tag.tagCtx.props.convert:depends;depends=linkCtx.view.getRsc("converters",depends)||depends;depends=depends&&depends.depends;depends=depends&&$sub._dp(depends,source,handler)}if(tagDepends=tag.depends){tagDepends=$sub._dp(tagDepends,tag,handler);depends=depends?depends.concat(tagDepends):tagDepends}linkedElems=tag.linkedElems}depends=depends||[];if(!linkCtx._depends||""+linkCtx._depends!==""+depends){exprFnDeps=linkCtx.fn.deps.slice();if(linkCtx._depends){bindId=linkCtx._depends.bdId;$observable._apply(1,[source],exprFnDeps,linkCtx._depends,handler,linkCtx._ctxCb,true)}if(tag&&tag.boundProps){l=tag.boundProps.length;while(l--){prop=tag.boundProps[l];k=tag._.bnd.paths.length;while(k--){propDeps=tag._.bnd.paths[k][prop];if(propDeps&&propDeps.skp){exprFnDeps=exprFnDeps.concat(propDeps)}}}}l=exprFnDeps.length;while(l--){exprOb=exprFnDeps[l];if(exprOb._cpfn){exprFnDeps[l]=$extend({},exprOb)}}binding=$observable._apply(1,[source],exprFnDeps,depends,handler,linkCtx._ctxCb);if(!bindId){bindId=linkCtx._bndId||""+bindingKey++;linkCtx._bndId=undefined;target._jsvBnd=(target._jsvBnd||"")+"&"+bindId;linkCtx.view._.bnds[bindId]=bindId}binding.elem=target;binding.linkCtx=linkCtx;binding._tgId=bindId;depends.bdId=bindId;linkCtx._depends=depends;bindingStore[bindId]=binding;if(linkedElems||cvtBk!==undefined||tag&&(tag.bindTo||tag.linkedElement||tag.linkedCtxParam)){defineBindToDataTargets(binding,tag,cvtBk)}if(linkedElems){l=linkedElems.length;while(l--){linkedElem=linkedElems[l];k=linkedElem&&linkedElem.length;while(k--){linkedElem[k]._jsvLkEl=tag;bindLinkedElChange(tag,linkedElem[k]);linkedElem[k]._jsvBnd="&"+bindId+"+"}}}else if(cvtBk!==undefined){bindLinkedElChange(tag,target)}if(tag){if(!tag.flow&&!tag.inline){target.setAttribute(jsvAttrStr,(target.getAttribute(jsvAttrStr)||"")+"#"+bindId+"^/"+bindId+"^");tag._tgId=""+bindId}}}}function lateLink(late){var lnkCtx;if(late){while(lnkCtx=late.pop()){lnkCtx._hdl()}}}function tmplLink(to,from,context,noIteration,parentView,prevNode,nextNode){return $link(this,to,from,context,noIteration,parentView,prevNode,nextNode)}function $link(tmplOrLinkExpr,to,from,context,noIteration,parentView,prevNode,nextNode){if(context===true){noIteration=context;context=undefined}else if(typeof context!=="object"){context=undefined}else{context=$extend({},context)}if(tmplOrLinkExpr&&to){to=to.jquery?to:$(to);if(!activeBody){activeBody=document.body;useInput="oninput"in activeBody;$(activeBody).on(elementChangeStr,onElemChange).on("blur.jsv","[contenteditable]",onElemChange)}var i,k,html,vwInfos,view,placeholderParent,targetEl,refresh,topLevelCall,late,onRender=addBindingMarkers,replaceMode=context&&context.target==="replace",l=to.length;while(l--){targetEl=to[l];parentView=parentView||$view(targetEl);if(topLevelCall=parentView===topView){topView.data=(topView.ctx=context||{}).root=from}if(""+tmplOrLinkExpr===tmplOrLinkExpr){addDataBinding(late=[],tmplOrLinkExpr,targetEl,parentView,undefined,true,from,context)}else{if(tmplOrLinkExpr.markup!==undefined){if(replaceMode){placeholderParent=targetEl.parentNode}parentView._.scp=true;html=tmplOrLinkExpr.render(from,context,noIteration,parentView,undefined,onRender,true);parentView._.scp=undefined;if(placeholderParent){prevNode=targetEl.previousSibling;nextNode=targetEl.nextSibling;$.cleanData([targetEl],true);placeholderParent.removeChild(targetEl);targetEl=placeholderParent}else{prevNode=nextNode=undefined;$(targetEl).empty()}}else if(tmplOrLinkExpr===true&&parentView===topView){refresh={lnk:1}}else{break}if(targetEl._df&&!nextNode){vwInfos=viewInfos(targetEl._df,true,rOpenViewMarkers);for(i=0,k=vwInfos.length;i<k;i++){view=vwInfos[i];if((view=viewStore[view.id])&&view.data!==undefined){view.parent.removeViews(view._.key,undefined,true)}}setDefer(targetEl)}late=parentView.link(from,targetEl,prevNode,nextNode,html,refresh,context)}lateLink(late)}}return to}function viewLink(outerData,parentNode,prevNode,nextNode,html,refresh,context,validateOnly){function convertMarkers(all,preceding,selfClose,closeTag,spaceBefore,id,boundId,spaceAfter,tag1,tag2,closeTag2,spaceAfterClose,selfClose2,endOpenTag){var errorMsg,bndId,endOfElCnt="";if(endOpenTag){inTag=0;return all}tag=tag1||tag2||"";closeTag=closeTag||closeTag2;selfClose=selfClose||selfClose2;if(isVoid&&!selfClose&&(!all||closeTag||tag||id&&!inTag)){isVoid=undefined;parentTag=tagStack.shift()}closeTag=closeTag||selfClose;if(closeTag){inTag=0;isVoid=undefined;if(validate){if(selfClose||selfClose2){if(!voidElems[parentTag]&&!/;svg;|;math;/.test(";"+tagStack.join(";")+";")){errorMsg="'<"+parentTag+".../"}}else if(voidElems[closeTag]){errorMsg="'</"+closeTag}else if(!tagStack.length||closeTag!==parentTag){errorMsg="Mismatch: '</"+closeTag}if(errorMsg){syntaxError(errorMsg+">' in:\n"+html)}}prevElCnt=elCnt;parentTag=tagStack.shift();elCnt=elContent[parentTag];closeTag2=closeTag2?"</"+closeTag2+">":"";if(prevElCnt){defer+=ids;ids="";if(!elCnt){endOfElCnt=closeTag2+openScript+"@"+defer+closeScript+(spaceAfterClose||"");defer=deferStack.shift()}else{defer+="-"}}}if(elCnt){if(id){ids+=id}else{preceding=closeTag2||selfClose2||""}if(tag){preceding+=tag;if(ids){preceding+=" "+jsvAttrStr+'="'+ids+'"';ids=""}}}else{preceding=id?preceding+endOfElCnt+spaceBefore+(inTag?"":openScript+id+closeScript)+spaceAfter+tag:endOfElCnt||all}if(validate&&boundId){if(inTag){syntaxError("{^{ within elem markup ("+inTag+' ). Use data-link="..."')}if(id.charAt(0)==="#"){tagStack.unshift(id.slice(1))}else if(id.slice(1)!==(bndId=tagStack.shift())){syntaxError("Closing tag for {^{...}} under different elem: <"+bndId+">")}}if(tag){inTag=tag;tagStack.unshift(parentTag);parentTag=tag.slice(1);if(validate&&tagStack[0]&&tagStack[0]===badParent[parentTag]){error("Parent of <tr> must be <tbody>")}isVoid=voidElems[parentTag];if((elCnt=elContent[parentTag])&&!prevElCnt){deferStack.unshift(defer);defer=""}prevElCnt=elCnt;if(defer&&elCnt){defer+="+"}}return preceding}function processViewInfos(vwInfos,targetParent){var deferPath,deferChar,bindChar,parentElem,id,onAftCr,deep,addedBindEls=[];if(vwInfos){if(vwInfos._tkns.charAt(0)==="@"){targetParent=elem.previousSibling;elem.parentNode.removeChild(elem);elem=undefined}len=vwInfos.length;while(len--){vwInfo=vwInfos[len];bindChar=vwInfo.ch;if(deferPath=vwInfo.path){j=deferPath.length-1;while(deferChar=deferPath.charAt(j--)){if(deferChar==="+"){if(deferPath.charAt(j)==="-"){j--;targetParent=targetParent.previousSibling}else{targetParent=targetParent.parentNode}}else{targetParent=targetParent.lastChild}}}if(bindChar==="^"){if(tag=bindingStore[id=vwInfo.id]){deep=targetParent&&(!elem||elem.parentNode!==targetParent);if(!elem||deep){tag.parentElem=targetParent}if(vwInfo.elCnt&&deep){setDefer(targetParent,(vwInfo.open?"#":"/")+id+bindChar+(targetParent._df||""))}addedBindEls.push([deep?null:elem,vwInfo])}}else if(view=viewStore[id=vwInfo.id]){if(!view.parentElem){view.parentElem=targetParent||elem&&elem.parentNode||parentNode;view._.onRender=addBindingMarkers;view._.onArrayChange=arrayChangeHandler;setArrayChangeLink(view)}parentElem=view.parentElem;if(vwInfo.open){view._elCnt=vwInfo.elCnt;if(targetParent&&!elem){setDefer(targetParent,"#"+id+bindChar+(targetParent._df||""))}else{if(!view._prv){setDefer(parentElem,removeSubStr(parentElem._df,"#"+id+bindChar))}view._prv=elem}}else{if(targetParent&&(!elem||elem.parentNode!==targetParent)){setDefer(targetParent,"/"+id+bindChar+(targetParent._df||""));view._nxt=undefined}else if(elem){if(!view._nxt){setDefer(parentElem,removeSubStr(parentElem._df,"/"+id+bindChar))}view._nxt=elem}if(onAftCr=view.ctx&&view.ctx[onAfterCreateStr]||onAfterCreate){onAftCr.call(view.ctx.tag,view)}}}}len=addedBindEls.length;while(len--){bindEls.push(addedBindEls[len])}}return!vwInfos||vwInfos.elCnt}function getViewInfos(vwInfos){var level,parentTag,named;if(vwInfos){len=vwInfos.length;for(j=0;j<len;j++){vwInfo=vwInfos[j];tag=bindingStore[vwInfo.id];if(!tag._is&&tag.linkCtx){parentTag=tag=tag.linkCtx.tag;named=tag.tagName===tagName;if(!tag.flow||named){if(!deep){level=1;while(parentTag=parentTag.parent){level++}tagDepth=tagDepth||level}if((deep||level===tagDepth)&&(!tagName||named)){tags.push(tag)}}}}}}function dataLink(){var j,index,tokens="",wrap={},selector=linkViewsSel+(get?",["+deferAttr+"]":"");elems=qsa?parentNode.querySelectorAll(selector):$(selector,parentNode).get();l=elems.length;if(prevNode&&prevNode.innerHTML){prevNodes=qsa?prevNode.querySelectorAll(selector):$(selector,prevNode).get();prevNode=prevNodes.length?prevNodes[prevNodes.length-1]:prevNode}tagDepth=0;for(i=0;i<l;i++){elem=elems[i];if(prevNode&&!found){found=elem===prevNode}else if(nextNode&&elem===nextNode){if(get){tokens+=markerNodeInfo(elem)}break}else if(elem.parentNode){if(get){tokens+=markerNodeInfo(elem);if(elem._df){j=i+1;while(j<l&&elem.contains(elems[j])){j++}wrap[j-1]=elem._df}if(wrap[i]){tokens+=wrap[i]||""}}else{if(isLink&&(vwInfo=viewInfos(elem,undefined,rViewMarkers))&&(vwInfo=vwInfo[0])){skip=skip?vwInfo.id!==skip&&skip:vwInfo.open&&vwInfo.id}if(!skip&&processInfos(viewInfos(elem))&&elem.getAttribute($viewsLinkAttr)){bindEls.push([elem])}}}}if(get){tokens+=parentNode._df||"";if(index=tokens.indexOf("#"+get.id)+1){tokens=tokens.slice(index+get.id.length)}index=tokens.indexOf("/"+get.id);if(index+1){tokens=tokens.slice(0,index)}getViewInfos(viewInfos(tokens,undefined,rOpenTagMarkers))}if(html===undefined&&parentNode.getAttribute($viewsLinkAttr)){bindEls.push([parentNode])}unmarkPrevOrNextNode(prevNode,elCnt);unmarkPrevOrNextNode(nextNode,elCnt);if(get){return}if(elCnt&&defer+ids){elem=nextNode;if(defer){if(nextNode){processViewInfos(viewInfos(defer+"+",true),nextNode)}else{processViewInfos(viewInfos(defer,true),parentNode)}}processViewInfos(viewInfos(ids,true),parentNode);if(nextNode){tokens=nextNode.getAttribute(jsvAttrStr);if(l=tokens.indexOf(prevIds)+1){tokens=tokens.slice(l+prevIds.length-1)}nextNode.setAttribute(jsvAttrStr,ids+tokens)}}l=bindEls.length;for(i=0;i<l;i++){elem=bindEls[i];linkInfo=elem[1];elem=elem[0];if(linkInfo){if(tag=bindingStore[linkInfo.id]){if(linkCtx=tag.linkCtx){tag=linkCtx.tag;tag.linkCtx=linkCtx}if(linkInfo.open){if(elem){tag.parentElem=elem.parentNode;tag._prv=elem}tag._elCnt=linkInfo.elCnt;view=tag.tagCtx.view;addDataBinding(late,undefined,tag._prv,view,linkInfo.id)}else{tag._nxt=elem;if(tag._.unlinked&&!tag._toLk){tagCtx=tag.tagCtx;view=tagCtx.view;callAfterLink(tag)}}}}else{addDataBinding(late,elem.getAttribute($viewsLinkAttr),elem,$view(elem),undefined,isLink,outerData,context)}}}var inTag,linkCtx,tag,i,l,j,len,elems,elem,view,vwInfo,linkInfo,prevNodes,token,prevView,nextView,node,tags,deep,tagName,tagCtx,validate,tagDepth,depth,fragment,copiedNode,firstTag,parentTag,isVoid,wrapper,div,tokens,elCnt,prevElCnt,htmlTag,ids,prevIds,found,skip,isLink,get,self=this,thisId=self._.id+"_",defer="",bindEls=[],tagStack=[],deferStack=[],late=[],onAfterCreate=changeHandler(self,onAfterCreateStr),processInfos=processViewInfos;if(refresh){if(refresh.tmpl){prevView="/"+refresh._.id+"_"}else{isLink=refresh.lnk;if(refresh.tag){thisId=refresh.tag+"^";refresh=true}if(get=refresh.get){processInfos=getViewInfos;tags=get.tags;deep=get.deep;tagName=get.name}}refresh=refresh===true}parentNode=parentNode?""+parentNode===parentNode?$(parentNode)[0]:parentNode.jquery?parentNode[0]:parentNode:self.parentElem||document.body;validate=!$subSettingsAdvanced.noValidate&&parentNode.contentEditable!==TRUE;parentTag=parentNode.tagName.toLowerCase();elCnt=!!elContent[parentTag];prevNode=prevNode&&markPrevOrNextNode(prevNode,elCnt);nextNode=nextNode&&markPrevOrNextNode(nextNode,elCnt)||null;if(html!=undefined){div=document.createElement("div");wrapper=div;prevIds=ids="";htmlTag=parentNode.namespaceURI==="http://www.w3.org/2000/svg"?"svg_ns":(firstTag=rFirstElem.exec(html))&&firstTag[1]||"";if(elCnt){node=nextNode;while(node&&!(nextView=viewInfos(node))){node=node.nextSibling}if(tokens=nextView?nextView._tkns:parentNode._df){token=prevView||"";if(refresh||!prevView){token+="#"+thisId}j=tokens.indexOf(token);if(j+1){j+=token.length;prevIds=ids=tokens.slice(0,j);tokens=tokens.slice(j);if(nextView){node.setAttribute(jsvAttrStr,tokens)}else{setDefer(parentNode,tokens)}}}}isVoid=undefined;html=(""+html).replace(rConvertMarkers,convertMarkers);if(validate&&tagStack.length){syntaxError("Mismatched '<"+parentTag+"...>' in:\n"+html)}if(validateOnly){return}safeFragment.appendChild(div);htmlTag=wrapMap[htmlTag]||wrapMap.div;depth=htmlTag[0];wrapper.innerHTML=htmlTag[1]+html+htmlTag[2];while(depth--){wrapper=wrapper.lastChild}safeFragment.removeChild(div);fragment=document.createDocumentFragment();while(copiedNode=wrapper.firstChild){fragment.appendChild(copiedNode)}parentNode.insertBefore(fragment,nextNode)}dataLink();return late}function addDataBinding(late,linkMarkup,node,currentView,boundTagId,isLink,data,context){var tmpl,tokens,attr,convertBack,tagExpr,linkFn,linkCtx,tag,rTagIndex,hasElse,lastIndex,linkExpressions=[];if(boundTagId){tag=bindingStore[boundTagId];tag=tag.linkCtx?tag.linkCtx.tag:tag;linkCtx=tag.linkCtx||{type:"inline",data:currentView.data,elem:tag._elCnt?tag.parentElem:node,view:currentView,ctx:currentView.ctx,attr:HTML,fn:tag._.bnd,tag:tag,_bndId:boundTagId};tag.linkCtx=linkCtx;bindDataLinkTarget(linkCtx,late);tag._toLk=linkCtx._bndId}else if(linkMarkup&&node){data=isLink?data:currentView.data;tmpl=currentView.tmpl;linkMarkup=normalizeLinkTag(linkMarkup,defaultAttr(node));lastIndex=rTagDatalink.lastIndex=0;while(tokens=rTagDatalink.exec(linkMarkup)){linkExpressions.push(tokens);lastIndex=rTagDatalink.lastIndex}if(lastIndex<linkMarkup.length){syntaxError(linkMarkup)}while(tokens=linkExpressions.shift()){rTagIndex=rTagDatalink.lastIndex;attr=tokens[1];tagExpr=tokens[3];while(linkExpressions[0]&&linkExpressions[0][4]==="else"){tagExpr+=delimCloseChar1+delimOpenChar0+linkExpressions.shift()[3];hasElse=true}if(hasElse){tagExpr+=delimCloseChar1+delimOpenChar0+delimOpenChar1+"/"+tokens[4]+delimCloseChar0}linkCtx={type:isLink?"top":"link",data:data,elem:node,view:currentView,ctx:context,attr:attr,isLk:isLink,_toLk:1,_noUpd:tokens[2]};convertBack=undefined;if(tokens[6]){convertBack=tokens[10]||undefined;linkCtx.convert=tokens[5]||"";if(convertBack!==undefined&&defaultAttr(node)){if(attr){syntaxError(tagExpr+"- Remove target: "+attr)}linkCtx.convertBack=convertBack=convertBack.slice(1)}}linkCtx.expr=attr+tagExpr;linkFn=tmpl.links[tagExpr];if(!linkFn){tmpl.links[tagExpr]=linkFn=$sub.tmplFn(tagExpr,tmpl,true,convertBack,hasElse)}linkCtx.fn=linkFn;bindDataLinkTarget(linkCtx,late);rTagDatalink.lastIndex=rTagIndex}}}function bindDataLinkTarget(linkCtx,late){function handler(ev,eventArgs){onDataLinkedTagChange.call(linkCtx,ev,eventArgs)}if(linkCtx.isLk){linkCtx.view=new $sub.View($sub.extendCtx(linkCtx.ctx,linkCtx.view.ctx),"link",linkCtx.view,linkCtx.data,linkCtx.expr,undefined,addBindingMarkers)}linkCtx._ctxCb=$sub._gccb(linkCtx.view);linkCtx._hdl=handler;if(linkCtx.fn._lr){linkCtx._toLk=1;late.push(linkCtx)}else{handler(true)}}function removeSubStr(str,substr){var k;return str?(k=str.indexOf(substr),k+1?str.slice(0,k)+str.slice(k+substr.length):str):""}function markerNodeInfo(node){return node&&(""+node===node?node:node.tagName===SCRIPT?node.type.slice(3):node.nodeType===1&&node.getAttribute(jsvAttrStr)||"")}function viewInfos(node,isVal,rBinding){function getInfos(all,open,close,id,ch,elPath){infos.push({elCnt:elCnt,id:id,ch:ch,open:open,close:close,path:elPath,token:all})}var elCnt,tokens,infos=[];if(tokens=isVal?node:markerNodeInfo(node)){elCnt=infos.elCnt=node.tagName!==SCRIPT;elCnt=tokens.charAt(0)==="@"||elCnt;infos._tkns=tokens;tokens.replace(rBinding||rMarkerTokens,getInfos);return infos}}function unmarkPrevOrNextNode(node,elCnt){if(node){if(node.type==="jsv"){node.parentNode.removeChild(node)}else if(elCnt&&node.getAttribute($viewsLinkAttr)===""){node.removeAttribute($viewsLinkAttr)}}}function markPrevOrNextNode(node,elCnt){var marker=node;while(elCnt&&marker&&marker.nodeType!==1){marker=marker.previousSibling}if(marker){if(marker.nodeType!==1){marker=document.createElement(SCRIPT);marker.type="jsv";node.parentNode.insertBefore(marker,node)}else if(!markerNodeInfo(marker)&&!marker.getAttribute($viewsLinkAttr)){marker.setAttribute($viewsLinkAttr,"")}}return marker}function normalizeLinkTag(linkMarkup,twoway){linkMarkup=$.trim(linkMarkup).replace(rEscapeQuotes,"\\$&");return linkMarkup.slice(-1)!==delimCloseChar0?linkMarkup=delimOpenChar1+":"+linkMarkup+(twoway?":":"")+delimCloseChar0:linkMarkup}function callAfterLink(tag,ev,eventArgs){function copyFromTagCtxToTag(){linkedElems=tagCtx.linkedElems||tag.linkedElems||tag.linkedElem&&[tag.linkedElem];if(linkedElems){tag.linkedElems=tagCtx.linkedElems=linkedElems;tag.linkedElem=linkedElems[0]=tag.linkedElem||linkedElems[0]}if(linkedElem=tagCtx.mainElem||tag.mainElem){tagCtx.mainElem=tag.mainElem=linkedElem}if(linkedElem=tagCtx.displayElem||tag.displayElem){tagCtx.displayElem=tag.displayElem=linkedElem}}var linkedElems,linkedElements,linkedElem,l,m,$linkCtxElem,linkCtxElem,tagCtxElse,props,val,oldVal,tagCtx=tag.tagCtx,tagCtxs=tag.tagCtxs,tagCtxslength=tagCtxs&&tagCtxs.length,linkCtx=tag.linkCtx,bindTo=tag.bindTo||{};if(tag._.unlinked){$linkCtxElem=$(linkCtx.elem);if(tag.linkedElement||tag.mainElement||tag.displayElement){if(linkedElements=tag.linkedElement){tag.linkedElem=undefined;l=linkedElements.length;while(l--){if(linkedElements[l]){m=tagCtxslength;while(m--){linkCtxElem=!m&&!tag.inline&&$linkCtxElem.filter(linkedElements[l]);tagCtxElse=tagCtxs[m];linkedElems=tagCtxElse.linkedElems=tagCtxElse.linkedElems||new Array(l);
linkedElem=linkCtxElem[0]?linkCtxElem:tagCtxElse.contents(true,linkedElements[l]);if(linkedElem[0]&&linkedElem[0].type!==RADIO){linkedElems[l]=linkedElem.eq(0)}}}}}if(linkedElements=tag.mainElement){m=tagCtxslength;while(m--){linkCtxElem=!m&&!tag.inline&&$linkCtxElem.filter(linkedElements);tagCtxElse=tagCtxs[m];linkedElem=linkCtxElem[0]?linkCtxElem:tagCtxElse.contents(true,linkedElements).eq(0);if(linkedElem[0]){tagCtxElse.mainElem=linkedElem}}}if(linkedElements=tag.displayElement){m=tagCtxslength;while(m--){linkCtxElem=!m&&!tag.inline&&$linkCtxElem.filter(linkedElements);tagCtxElse=tagCtxs[m];linkedElem=linkCtxElem[0]?linkCtxElem:tagCtxElse.contents(true,linkedElements).eq(0);if(linkedElem[0]){tagCtxElse.displayElem=linkedElem;if(!m){tag.displayElem=linkedElem}}}}copyFromTagCtxToTag()}if(tag.onBind){tag.onBind(tagCtx,linkCtx,tag.ctx,ev,eventArgs);copyFromTagCtxToTag()}}m=tagCtxslength;while(m--){tagCtxElse=tagCtxs[m];props=tagCtxElse.props;if(linkedElem=tagCtxElse.mainElem||!tag.mainElement&&tagCtxElse.linkedElems&&tagCtxElse.linkedElems[0]){if(linkedElem[0]&&props.id&&!linkedElem[0].id){linkedElem[0].id=props.id}if(tag.setSize){if(val=!bindTo.height&&props.height||tag.height){linkedElem.height(val)}if(val=!bindTo.width&&props.width||tag.width){linkedElem.width(val)}}}if(val=(linkedElem=tagCtxElse.displayElem||linkedElem)&&(!bindTo["class"]&&props["class"]||tag.className)){oldVal=linkedElem[0]._jsvCl;if(val!==oldVal){if(linkedElem.hasClass(oldVal)){linkedElem.removeClass(oldVal)}linkedElem.addClass(val);linkedElem[0]._jsvCl=val}}}if(tag.onAfterLink){tag.onAfterLink(tagCtx,linkCtx,tag.ctx,ev,eventArgs);copyFromTagCtxToTag()}if(!tag.flow&&!tag._.chg){if(tag.inline&&tag._.unlinked&&(tag.linkedElems||bindTo)){defineBindToDataTargets(bindingStore[tag._tgId],tag)}tag.setValue()}tag._.unlinked=undefined}function asyncOnElemChange(ev){var which=ev.which;if(!(which>15&&which<21||which>32&&which<41||which>111&&which<131||which===27||which===144)){setTimeout(function(){onElemChange(ev)})}}function bindTriggerEvent($elem,trig,onoff){if(trig===true&&useInput){$elem[onoff]("input.jsv",onElemChange)}else{trig=""+trig===trig?trig:"keydown.jsv";$elem[onoff](trig,trig.indexOf("keydown")>=0?asyncOnElemChange:onElemChange)}}function bindLinkedElChange(tag,linkedElem){var $linkedElem,newTrig,oldTrig=linkedElem._jsvTr||false;if(tag){newTrig=tag.tagCtx.props.trigger;if(newTrig===undefined){newTrig=tag.trigger}}if(newTrig===undefined){newTrig=$subSettings.trigger}newTrig=newTrig&&(linkedElem.tagName==="INPUT"&&linkedElem.type!==CHECKBOX&&linkedElem.type!==RADIO||linkedElem.type==="textarea"||linkedElem.contentEditable===TRUE)&&newTrig||false;if(oldTrig!==newTrig){$linkedElem=$(linkedElem);bindTriggerEvent($linkedElem,oldTrig,"off");bindTriggerEvent($linkedElem,linkedElem._jsvTr=newTrig,"on")}}function defineBindToDataTargets(binding,tag,cvtBk){var pathIndex,path,lastPath,bindtoOb,to,bindTo,paths,k,l,obsCtxPrm,linkedCtxParam,contextCb,targetPaths,bindTos,tagElse=1,tos=[],linkCtx=binding.linkCtx,source=linkCtx.data,targetPathsElses=linkCtx.fn.paths;if(binding&&!binding.to){if(tag){tag.convertBack=tag.convertBack||cvtBk;bindTo=tag.bindTo;tagElse=tag.tagCtxs?tag.tagCtxs.length:1}while(tagElse--){bindTos=[];if(targetPaths=targetPathsElses[tagElse]){bindTo=targetPaths._jsvto?["_jsvto"]:bindTo||[0];k=bindTo.length;while(k--){path="";contextCb=linkCtx._ctxCb;paths=targetPaths[bindTo[k]];if(pathIndex=paths&&paths.length){lastPath=paths[pathIndex-1];if(lastPath._cpfn){bindtoOb=lastPath;while(lastPath.sb&&lastPath.sb._cpfn){path=lastPath=lastPath.sb}path=lastPath.sb||path&&path.path;lastPath=path?path.slice(1):bindtoOb.path}to=path?[bindtoOb,lastPath]:resolveDataTargetPath(lastPath,source,contextCb)}else{linkedCtxParam=tag.linkedCtxParam;to=[];if(linkedCtxParam&&linkedCtxParam[k]){to=[tag.tagCtxs[tagElse].ctx[linkedCtxParam[k]][0],_ocp]}}if((obsCtxPrm=to._cxp)&&obsCtxPrm.tag&&lastPath.indexOf(".")<0){to=obsCtxPrm}bindTos.unshift(to)}}tos.unshift(bindTos)}binding.to=tos}}function resolveDataTargetPath(targetPath,source,contextCb){var path,bindtoOb,to,l,obsCtxPrm,view,topCp,data;while(targetPath&&targetPath!==_ocp&&(to=contextCb(path=targetPath.split("^").join("."),source))&&(l=to.length)){if(obsCtxPrm=to[0]._cxp){topCp=topCp||obsCtxPrm;view=to[0][0];if(_ocp in view){data=view;view=view._vw}else{data=view.data}topCp.path=targetPath=to[0][1];to=[topCp.data=data,targetPath];contextCb=$sub._gccb(view);if(targetPath._cpfn){bindtoOb=targetPath;bindtoOb.data=to[0];bindtoOb._cpCtx=contextCb;while(targetPath.sb&&targetPath.sb._cpfn){path=targetPath=targetPath.sb}path=targetPath.sb||path&&path.path;targetPath=path?path.slice(1):bindtoOb.path;to=[bindtoOb,targetPath]}else if(obsCtxPrm.tag&&obsCtxPrm.path===_ocp){to=obsCtxPrm}}else{to=l>2?[to[l-3],to[l-2]]:[to[l-2]]}source=to[0];targetPath=to[1]}to=to||[source,path];to._cxp=topCp;return to}function mergeCtxs(tag,newCtxs,replace){var tagCtx,newTagCtx,view=tag.tagCtx.view,tagCtxs=tag.tagCtxs||[tag.tagCtx],l=tagCtxs.length,refresh=!newCtxs;newCtxs=newCtxs||tag._.bnd.call(view.tmpl,(tag.linkCtx||view).data,view,$sub);if(replace){tagCtxs=tag.tagCtxs=newCtxs;tag.tagCtx=tagCtxs[0];addLinkMethods(tag)}else{while(l--){tagCtx=tagCtxs[l];newTagCtx=newCtxs[l];$observable(tagCtx.props).setProperty(newTagCtx.props);$extend(tagCtx.ctx,newTagCtx.ctx);tagCtx.args=newTagCtx.args;if(refresh){tagCtx.tmpl=newTagCtx.tmpl}}}$sub._ths(tag,tagCtxs[0]);return tagCtxs}function clean(elems){var l,elem,bindings,elemArray=[],len=elems.length,i=len;while(i--){elemArray.push(elems[i])}i=len;while(i--){elem=elemArray[i];if(elem.parentNode){if(bindings=elem._jsvBnd){bindings=bindings.slice(1).split("&");elem._jsvBnd="";l=bindings.length;while(l--){removeViewBinding(bindings[l],elem._jsvLkEl,elem)}}disposeTokens(markerNodeInfo(elem)+(elem._df||""),elem)}}}function removeViewBinding(bindId,linkedElemTag,elem){var objId,linkCtx,tag,object,obsId,tagCtxs,l,map,linkedElem,trigger,view,tagCtx,linkedElems,allLinkedElems,binding=bindingStore[bindId];if(linkedElemTag){elem._jsvLkEl=undefined}else if(binding&&(!elem||elem===binding.elem)){delete bindingStore[bindId];for(objId in binding.bnd){object=binding.bnd[objId];obsId=binding.cbId;if($isArray(object)){$([object]).off(arrayChangeStr+obsId).off(propertyChangeStr+obsId)}else{$(object).off(propertyChangeStr+obsId)}delete binding.bnd[objId]}if(linkCtx=binding.linkCtx){if(tag=linkCtx.tag){if(tagCtxs=tag.tagCtxs){l=tagCtxs.length;while(l--){tagCtx=tagCtxs[l];if(map=tagCtx.map){map.unmap()}if(linkedElems=tagCtx.linkedElems){allLinkedElems=(allLinkedElems||[]).concat(linkedElems)}}}if(tag.onUnbind){tag.onUnbind(tag.tagCtx,linkCtx,tag.ctx,true)}if(tag.onDispose){tag.onDispose()}if(!tag._elCnt){if(tag._prv){tag._prv.parentNode.removeChild(tag._prv)}if(tag._nxt){tag._nxt.parentNode.removeChild(tag._nxt)}}}linkedElems=allLinkedElems||[$(linkCtx.elem)];l=linkedElems.length;while(l--){linkedElem=linkedElems[l];if(trigger=linkedElem&&linkedElem[0]&&linkedElem[0]._jsvTr){bindTriggerEvent(linkedElem,trigger,"off");linkedElem[0]._jsvTr=undefined}}view=linkCtx.view;if(view.type==="link"){view.parent.removeViews(view._.key,undefined,true)}else{delete view._.bnds[bindId]}}delete binding.s[binding.cbId]}}function $unlink(to){if(to){to=to.jquery?to:$(to);to.each(function(){var innerView;while((innerView=$view(this,true))&&innerView.parent){innerView.parent.removeViews(innerView._.key,undefined,true)}clean(this.getElementsByTagName("*"))});clean(to)}else{if(activeBody){$(activeBody).off(elementChangeStr,onElemChange).off("blur.jsv","[contenteditable]",onElemChange);activeBody=undefined}topView.removeViews();clean(document.body.getElementsByTagName("*"))}}function inputAttrib(elem){return elem.type===CHECKBOX?elem[CHECKED]:elem.value}function changeHandler(view,name,tag){return tag&&tag[name]||view.ctx[name]&&view.ctxPrm(name)||$views.helpers[name]}addLinkMethods($sub.View.prototype);$sub.onStore.template=function(name,item,parentTmpl){if(item===null){delete $.link[name];delete $.render[name]}else{item.link=tmplLink;if(name&&!parentTmpl&&name!=="jsvTmpl"){$.render[name]=item;$.link[name]=function(){return tmplLink.apply(item,arguments)}}}};$sub.viewInfos=viewInfos;($viewsSettings.delimiters=function(){var ret=oldJsvDelimiters.apply(0,arguments),delimChars=$subSettings.delimiters;delimOpenChar0=delimChars[0].charAt(0);delimOpenChar1=delimChars[0].charAt(1);delimCloseChar0=delimChars[1].charAt(0);delimCloseChar1=delimChars[1].charAt(1);linkChar=delimChars[2];rTagDatalink=new RegExp("(?:^|\\s*)([\\w-]*)(\\"+linkChar+")?(\\"+delimOpenChar1+$sub.rTag+"(:\\w*)?\\"+delimCloseChar0+")","g");return ret})();$sub.addSetting("trigger");function transferViewTokens(prevNode,nextNode,parentElem,id,viewOrTagChar,refresh){var i,l,vwInfos,vwInfo,viewOrTag,viewId,tokens,precedingLength=0,emptyView=prevNode===nextNode;if(prevNode){vwInfos=viewInfos(prevNode)||[];for(i=0,l=vwInfos.length;i<l;i++){vwInfo=vwInfos[i];viewId=vwInfo.id;if(viewId===id&&vwInfo.ch===viewOrTagChar){if(refresh){l=0}else{break}}if(!emptyView){viewOrTag=vwInfo.ch==="_"?viewStore[viewId]:bindingStore[viewId].linkCtx.tag;if(vwInfo.open){viewOrTag._prv=nextNode}else if(vwInfo.close){viewOrTag._nxt=nextNode}}precedingLength+=viewId.length+2}if(precedingLength){prevNode.setAttribute(jsvAttrStr,prevNode.getAttribute(jsvAttrStr).slice(precedingLength))}tokens=nextNode?nextNode.getAttribute(jsvAttrStr):parentElem._df;if(l=tokens.indexOf("/"+id+viewOrTagChar)+1){tokens=vwInfos._tkns.slice(0,precedingLength)+tokens.slice(l+(refresh?-1:id.length+1))}if(tokens){if(nextNode){nextNode.setAttribute(jsvAttrStr,tokens)}else{setDefer(parentElem,tokens)}}}else{setDefer(parentElem,removeSubStr(parentElem._df,"#"+id+viewOrTagChar));if(!refresh&&!nextNode){setDefer(parentElem,removeSubStr(parentElem._df,"/"+id+viewOrTagChar))}}}function disposeTokens(tokens,elem){var i,l,vwItem,vwInfos;if(vwInfos=viewInfos(tokens,true,rOpenMarkers)){for(i=0,l=vwInfos.length;i<l;i++){vwItem=vwInfos[i];if(vwItem.ch==="_"){if((vwItem=viewStore[vwItem.id])&&vwItem.type&&(!elem||vwItem._prv===elem||vwItem.parentElem===elem)){vwItem.parent.removeViews(vwItem._.key,undefined,true)}}else{removeViewBinding(vwItem.id,undefined,elem)}}}}function updateValue(val,index,tagElse,bindId,ev){var values=[];if(this&&this._tgId){bindId=this}values[index||0]=val;updateValues(values,tagElse,bindId,ev);return this}function setValues(){var args=arguments,m=args.length;if(!m){args=this.tag.cvtArgs(true,this.index);m=args.length}while(m--){this.tag.setValue(args[m],m,this.index)}}function addLinkMethods(tagOrView){var l,m,tagCtx,boundProps,bindTo,key,theTag,theView;tagOrView.contents=function(deep,select){if(deep!==!!deep){select=deep;deep=undefined}var filtered,nodes=$(this.nodes());if(nodes[0]){filtered=select?nodes.filter(select):nodes;nodes=deep&&select?filtered.add(nodes.find(select)):filtered}return nodes};tagOrView.nodes=function(withMarkers,prevNode,nextNode){var node,self=this.contentView||this,elCnt=self._elCnt,prevIsFirstNode=!prevNode&&elCnt,nodes=[];if(!self.args){prevNode=prevNode||self._prv;nextNode=nextNode||self._nxt;node=prevIsFirstNode?prevNode===self._nxt?self.parentElem.lastSibling:prevNode:self.inline===false?prevNode||self.linkCtx.elem.firstChild:prevNode&&prevNode.nextSibling;while(node&&(!nextNode||node!==nextNode)){if(withMarkers||elCnt||node.tagName!==SCRIPT){nodes.push(node)}node=node.nextSibling}}return nodes};tagOrView.childTags=function(deep,tagName){if(deep!==!!deep){tagName=deep;deep=undefined}var self=this.contentView||this,view=self.link?self:self.tagCtx.view,prevNode=self._prv,elCnt=self._elCnt,tags=[];if(!self.args){view.link(undefined,self.parentElem,elCnt?prevNode&&prevNode.previousSibling:prevNode,self._nxt,undefined,{get:{tags:tags,deep:deep,name:tagName,id:self.link?self._.id+"_":self._tgId+"^"}})}return tags};if(tagOrView._is==="tag"){theTag=tagOrView;m=theTag.tagCtxs.length;while(m--){tagCtx=theTag.tagCtxs[m];tagCtx.setValues=setValues;tagCtx.cvtArgs=$sub._tg.prototype.cvtArgs;tagCtx.bndArgs=$sub._tg.prototype.bndArgs;tagCtx.contents=tagOrView.contents;tagCtx.childTags=tagOrView.childTags;tagCtx.nodes=tagOrView.nodes}boundProps=theTag.boundProps=theTag.boundProps||[];if(bindTo=theTag.linkTo?["linkTo"]:theTag.bindTo){l=bindTo.length;while(l--){key=bindTo[l];if(key+""===key){bindTo[key]=1;if($.inArray(key,boundProps)<0){boundProps.push(key)}}}}theTag.setValue=$sub._gm(theTag.constructor.prototype.setValue,function(val,index,tagElse){if(!arguments.length){theTag.setValues();return theTag}var linkedElem,linkedEl,linkedTag,linkedCtxParam=theTag.linkedCtxParam,tagCtx=theTag.tagCtxs[tagElse||0],props=tagCtx.props,linkCtx=theTag.linkCtx,linkedElems=tagCtx.linkedElems||theTag.linkedElem&&[theTag.linkedElem];if(val!==undefined){theTag.base.call(theTag,val,index,tagElse)}else if(theTag.getValue&&(val=theTag.getValue(tagElse))&&val!==undefined){if(theTag.bindTo.length>1){val=val[index]}if(linkedCtxParam&&linkedCtxParam[index]){$.observable(tagCtx.ctx[linkedCtxParam[index]][0]).setProperty(_ocp,val)}}if((linkedElem=linkedElems&&linkedElems[index])&&linkedElem[0]){l=linkedElem.length;while(l--){linkedEl=linkedElem[l];if(theTag._.unlinked){linkedTag=linkedEl._jsvLkEl;if(!linkedTag||linkedTag!==theTag){if(linkedTag){val=linkedTag.cvtArgs(true,tagElse)[index]}linkedEl._jsvLkEl=theTag;linkedEl._jsvInd=index;linkedEl._jsvElse=tagElse;bindLinkedElChange(theTag,linkedEl);linkedEl._jsvBnd="&"+theTag._tgId+"+"}}if(val!==undefined&&!linkedEl._jsvChg&&linkCtx._val!==val){if(linkedEl.value!==undefined){if(linkedEl.type===CHECKBOX){linkedEl[CHECKED]=val&&val!=="false"}else if(linkedEl.type===RADIO){linkedEl[CHECKED]=linkedEl.value===val}else if($isArray(val)){linkedEl.value=val}else{$(linkedEl).val(val)}}else if(linkedEl.contentEditable===TRUE){linkedEl.innerHTML=val}}if(props.name){linkedEl.name=linkedEl.name||props.name}}}return theTag});theTag.updateValue=updateValue;theTag.updateValues=function(){return updateValues(arguments,undefined,this)};theTag.setValues=function(){var m=arguments.length?1:theTag.tagCtxs.length;while(m--){setValues.apply(theTag.tagCtxs[m],arguments)}};theTag.refresh=function(sourceValue){var attr,linkCtx=theTag.linkCtx,view=theTag.tagCtx.view;if(theTag.onUnbind){theTag.onUnbind(theTag.tagCtx,linkCtx,theTag.ctx)}attr=theTag.inline?HTML:linkCtx.attr||defaultAttr(theTag.parentElem,true);sourceValue=$sub._tag(theTag,view,view.tmpl,mergeCtxs(theTag),true);updateContent(sourceValue,linkCtx,attr,theTag);callAfterLink(theTag);return theTag};theTag.domChange=function(){var elem=this.parentElem,hasListener=$.hasData(elem)&&$._data(elem).events,domChangeNotification="jsv-domchange";if(hasListener&&hasListener[domChangeNotification]){$(elem).triggerHandler(domChangeNotification,arguments)}}}else{theView=tagOrView;theView.addViews=function(index,dataItems){var i,viewsCount,view=this,itemsCount=dataItems.length,views=view.views;if(!view._.useKey&&itemsCount){viewsCount=views.length+itemsCount;if(viewsCount===view.data.length&&renderAndLink(view,index,view.tmpl,views,dataItems,view.ctx)!==false){if(!view._.srt){view.fixIndex(index+itemsCount)}}}};theView.removeViews=function(index,itemsCount,keepNodes,isMove){function removeView(index){var id,bindId,parentElem,prevNode,nextNode,nodesToRemove,viewToRemove=views[index];if(viewToRemove&&viewToRemove.link){id=viewToRemove._.id;if(!keepNodes){nodesToRemove=viewToRemove.nodes()}viewToRemove.removeViews(undefined,undefined,true);viewToRemove.type=undefined;prevNode=viewToRemove._prv;nextNode=viewToRemove._nxt;parentElem=viewToRemove.parentElem;if(!keepNodes){if(viewToRemove._elCnt){transferViewTokens(prevNode,nextNode,parentElem,id,"_")}$(nodesToRemove).remove()}if(!viewToRemove._elCnt){try{prevNode.parentNode.removeChild(prevNode);nextNode.parentNode.removeChild(nextNode)}catch(e){}}setArrayChangeLink(viewToRemove);for(bindId in viewToRemove._.bnds){removeViewBinding(bindId)}delete viewStore[id]}}var current,childView,viewsCount,view=this,isArray=!view._.useKey,views=view.views;if(isArray){viewsCount=views.length}if(index===undefined){if(isArray){current=viewsCount;while(current--){removeView(current)}view.views=[]}else{for(childView in views){removeView(childView)}view.views={}}}else{if(itemsCount===undefined){if(isArray){itemsCount=1}else{removeView(index);delete views[index]}}if(isArray&&itemsCount&&(isMove||viewsCount-itemsCount===view.data.length)){current=index+itemsCount;while(current-->index){removeView(current)}views.splice(index,itemsCount);if(!view._.srt){view.fixIndex(index)}}}};theView.moveViews=function(oldIndex,index,itemsCount){function parts(itemView,str){return RegExp("^(.*)("+(str?"\\/":"#")+itemView._.id+"_.*)$").exec(str||itemView._prv.getAttribute(jsvAttrStr))}function setPrv(itemView,tokens){itemView._prv.setAttribute(jsvAttrStr,tokens)}var nodes,childView,nxtView,insertBefore,viewId,view=this,selfNxt=view._nxt,views=view.views,backwards=index<oldIndex,firstChange=backwards?index:oldIndex,lastChange=backwards?oldIndex:index,i=index,movedNodes=[],viewsToMove=views.splice(oldIndex,itemsCount);if(index>views.length){index=views.length}views.splice.apply(views,[index,0].concat(viewsToMove));itemsCount=viewsToMove.length;insertBefore=index+itemsCount;lastChange+=itemsCount;for(i;i<insertBefore;i++){childView=views[i];nodes=childView.nodes(true);movedNodes=view._elCnt?movedNodes.concat(nodes):movedNodes.concat(childView._prv,nodes,childView._nxt)}movedNodes=$(movedNodes);if(insertBefore<views.length){movedNodes.insertBefore(views[insertBefore]._prv)}else if(selfNxt){movedNodes.insertBefore(selfNxt)}else{movedNodes.appendTo(view.parentElem)}if(view._elCnt){var afterParts,endChange=backwards?firstChange+itemsCount:lastChange-itemsCount,beforeView=views[firstChange-1],startView=views[firstChange],endView=views[endChange],afterView=views[lastChange],startParts=parts(startView),endParts=parts(endView);setPrv(startView,endParts[1]+startParts[2]);if(afterView){afterParts=parts(afterView);setPrv(afterView,startParts[1]+afterParts[2])}else{if(selfNxt){afterParts=parts(view,selfNxt.getAttribute(jsvAttrStr));selfNxt.setAttribute(jsvAttrStr,startParts[1]+afterParts[2])}else{afterParts=parts(view,view.parentElem._df);setDefer(view.parentElem,startParts[1]+afterParts[2])}}setPrv(endView,afterParts[1]+endParts[2]);if(beforeView){beforeView._nxt=startView._prv}else{view._prv=startView._prv}views[endChange-1]._nxt=endView._prv;views[lastChange-1]._nxt=afterView?afterView._prv:selfNxt}view.fixIndex(firstChange)};theView.refresh=function(){var view=this,parent=view.parent;if(parent){renderAndLink(view,view.index,view.tmpl,parent.views,view.data,undefined,true);setArrayChangeLink(view)}};theView.fixIndex=function(fromIndex){var views=this.views,index=views.length;while(fromIndex<index--){if(views[index].index!==index){$observable(views[index]).setProperty("index",index)}}};theView.link=viewLink}}$converters.merge=function(val){var regularExpression,currentValue=this.linkCtx.elem.className,toggle=this.tagCtx.props.toggle;if(toggle){regularExpression=toggle.replace(/[\\^$.|?*+()[{]/g,"\\$&");regularExpression="(\\s(?="+regularExpression+"$)|(\\s)|^)("+regularExpression+"(\\s|$))";currentValue=currentValue.replace(new RegExp(regularExpression),"$2");val=currentValue+(val?(currentValue&&" ")+toggle:"")}return val};$tags({on:{attr:NONE,init:function(tagCtx){var content,tag=this,i=0,args=tagCtx.args,l=args.length;for(;i<l&&!$isFunction(args[i]);i++);tag._hi=l>i&&i+1;if(tag.inline){if(!$sub.rTmpl.exec(content=$.trim(tagCtx.tmpl.markup))){tag.template="<button>"+(content||tagCtx.params.args[i]||"noop")+"</button>"}tag.attr=HTML}},onBind:function(){if(this.template){this.mainElem=this.contents("button")}},onAfterLink:function(tagCtx,linkCtx){var handler,params,find,activeElem,tag=this,i=tag._hi,args=tagCtx.args,l=args.length,props=tagCtx.props,data=props.data,view=tagCtx.view,contextOb=props.context;if(i){handler=args[i-1];params=args.slice(i);args=args.slice(0,i-1);tag._sel=args[1];activeElem=tag.activeElem=tag.activeElem||$(tag.inline?(tag._sel=args[1]||"*",tag.parentElem):linkCtx.elem);if(!contextOb){contextOb=/^(.*)[\.^][\w$]+$/.exec(tagCtx.params.args.slice(-params.length-1)[0]);contextOb=contextOb&&$sub.tmplFn(delimOpenChar1+":"+contextOb[1]+delimCloseChar0,view.tmpl,true)(linkCtx.data,view)}if(tag._evs){tag.onUnbind()}activeElem.on(tag._evs=args[0]||"click",tag._sel,data==undefined?null:data,tag._hlr=function hndlr(ev){var nodes,length,found=!tag.inline;if(!found){nodes=tag.contents("*");l=nodes.length;while(!found&&l--){if(nodes[l].contains(ev.target)){found=true}}}if(found){return handler.apply(contextOb||linkCtx.data,[].concat(params,ev,{change:ev.type,view:view,linkCtx:linkCtx},params.slice.call(arguments,1)))}})}},onUpdate:false,onUnbind:function(){var self=this;if(self.activeElem){self.activeElem.off(self._evs,self._sel,self._hlr)}},contentCtx:true,setSize:true,dataBoundOnly:true},radiogroup:{init:function(tagCtx){this.name=tagCtx.props.name||(Math.random()+"jsv").slice(9)},onBind:function(tagCtx,linkCtx){var domChngCntnr,$linkedElem,l,tag=this;if(tag.inline){domChngCntnr=tag.contents("*")[0];domChngCntnr=domChngCntnr&&$view(domChngCntnr).ctx.tag===tag.parent?domChngCntnr:tag.parentElem;$linkedElem=tag.contents(true,"input[type=radio]")}else{domChngCntnr=linkCtx.elem;$linkedElem=$("input[type=radio]",linkCtx.elem)}tag.linkedElem=$linkedElem;l=$linkedElem.length;while(l--){$linkedElem[l].name=$linkedElem[l].name||tag.name}$(domChngCntnr).on("jsv-domchange",function(ev,forOrIfTagCtx){var linkedElem,val,parentTags=forOrIfTagCtx.ctx.parentTags;if(!tag.inline||domChngCntnr!==tag.parentElem||parentTags&&parentTags[tag.tagName]===tag){val=tag.cvtArgs()[0];$linkedElem=tag.linkedElem=tag.contents(true,"input[type=radio]");l=$linkedElem.length;while(l--){linkedElem=$linkedElem[l];linkedElem._jsvLkEl=tag;linkedElem.name=linkedElem.name||tag.name;linkedElem._jsvBnd="&"+tag._tgId+"+";linkedElem.checked=val===linkedElem.value}tag.linkedElems=tagCtx.linkedElems=[$linkedElem]}})},onUpdate:false,contentCtx:true,dataBoundOnly:true}});$extend($tags["for"],{onArrayChange:function(ev,eventArgs,tagCtx,linkCtx){var arrayView,target=ev.target,targetLength=target.length,tag=this,change=eventArgs.change;if(tag._.noVws||tag.tagCtxs[1]&&(change==="insert"&&targetLength===eventArgs.items.length||change==="remove"&&!targetLength)){tag.refresh()}else{for(arrayView in tag._.arrVws){arrayView=tag._.arrVws[arrayView];if(arrayView.data===target){arrayChangeHandler.apply(arrayView,arguments)}}}tag.domChange(tagCtx,linkCtx,eventArgs);ev.done=true},onAfterLink:function(tagCtx,linkCtx){var arrHandler,arrBinding,data,tag=this,i=0,arrayBindings=tag._ars||{},tagCtxs=tag.tagCtxs,l=tagCtxs.length,selected=tag.selected||0;for(;i<=selected;i++){tagCtx=tagCtxs[i];data=tagCtx.map?tagCtx.map.tgt:tagCtx.args.length?tagCtx.args[0]:tagCtx.view.data;if((arrBinding=arrayBindings[i])&&data!==arrBinding[0]){$observe(arrBinding[0],arrBinding[1],true);delete arrayBindings[i]}if(!arrayBindings[i]&&$isArray(data)){(function(){var tagCt=tagCtx;$observe(data,arrHandler=function(ev,eventArgs){tag.onArrayChange(ev,eventArgs,tagCt,linkCtx)});arrayBindings[i]=[data,arrHandler]})()}}for(i=selected+1;i<l;i++){if(arrBinding=arrayBindings[i]){$observe(arrBinding[0],arrBinding[1],true);delete arrayBindings[i]}}tag._ars=arrayBindings},onDispose:function(){var l,tag=this;for(l in tag._ars){$observe(tag._ars[l][0],tag._ars[l][1],true)}}});$extend($tags["if"],{onUpdate:function(ev,eventArgs,newTagCtxs){var prevArg,different,tci=0;for(;prevArg=this.tagCtxs[tci];tci++){different=prevArg.props.tmpl!==newTagCtxs[tci].props.tmpl||prevArg.args.length&&!(prevArg=prevArg.args[0])!==!newTagCtxs[tci].args[0];if(!this.convert&&!!prevArg||different){return different}}return false},onAfterLink:function(tagCtx,linkCtx,ctx,ev,eventArgs){if(eventArgs){this.domChange(tagCtx,linkCtx,eventArgs)}}});function observeProps(map,ev,eventArgs){if(eventArgs.change==="set"){var target=map.tgt,l=target.length;while(l--){if(target[l].key===eventArgs.path){break}}if(l===-1){if(eventArgs.path&&!eventArgs.remove){$observable(target).insert({key:eventArgs.path,prop:eventArgs.value})}}else if(eventArgs.remove){$observable(target).remove(l)}else{$observable(target[l]).setProperty("prop",eventArgs.value)}}}function observeMappedProps(map,ev,eventArgs){var item,source=map.src,change=eventArgs.change;if(change==="set"){if(eventArgs.path==="prop"){$observable(source).setProperty(ev.target.key,eventArgs.value)}else{$observable(source).removeProperty(eventArgs.oldValue);$observable(source).setProperty(eventArgs.value,ev.target.prop)}}else if(change==="remove"){item=eventArgs.items[0];$observable(source).removeProperty(item.key);delete source[item.key]}else if(change==="insert"){item=eventArgs.items[0];if(item.key){$observable(source).setProperty(item.key,item.prop)}}}function shallowArrayFilter(allPath){return allPath.indexOf(".")<0}$tags("props",{baseTag:"for",dataMap:$views.map({getTgt:$tags.props.dataMap.getTgt,obsSrc:observeProps,obsTgt:observeMappedProps,tgtFlt:shallowArrayFilter}),flow:true});$extend($,{view:$view=function(node,inner,type){function getInnerView(nd,isVl){if(nd){vwInfos=viewInfos(nd,isVl,rOpenViewMarkers);for(j=0,k=vwInfos.length;j<k;j++){if((view=viewStore[vwInfos[j].id])&&(view=view&&type?view.get(true,type):view)){break}}}}if(inner!==!!inner){type=inner;inner=undefined}var view,vwInfos,i,j,k,l,elems,level=0,body=document.body;if(node&&node!==body&&topView._.useKey>1){node=""+node===node?$(node)[0]:node.jquery?node[0]:node;if(node){if(inner){getInnerView(node._df,true);if(!view){elems=qsa?node.querySelectorAll(bindElsSel):$(bindElsSel,node).get();l=elems.length;for(i=0;!view&&i<l;i++){getInnerView(elems[i])}}return view}while(node){if(vwInfos=viewInfos(node,undefined,rViewMarkers)){l=vwInfos.length;while(l--){view=vwInfos[l];if(view.open){if(level<1){view=viewStore[view.id];return view&&type?view.get(type):view||topView}level--}else{level++}}}node=node.previousSibling||node.parentNode}}}return topView},link:$link,unlink:$unlink,cleanData:function(elems){if(elems.length&&isCleanCall){clean(elems)}oldCleanData.apply($,arguments)}});$extend($.fn,{link:function(expr,from,context,noIteration,parentView,prevNode,nextNode){return $link(expr,this,from,context,noIteration,parentView,prevNode,nextNode)},unlink:function(){return $unlink(this)},view:function(inner,type){return $view(this[0],inner,type)}});$.each([HTML,"replaceWith","empty","remove"],function(i,name){var oldFn=$.fn[name];$.fn[name]=function(){var result;isCleanCall=1;try{result=oldFn.apply(this,arguments)}finally{isCleanCall=0}return result}});$extend(topView=$sub.topView,{tmpl:{links:{}}});viewStore={0:topView};$sub._glt=function(elem){var linkCtx,regEx=/#(\d*)\^\/\1\^/g,linkCtxs=[],tokens=markerNodeInfo(elem);while(linkCtx=regEx.exec(tokens)){if(linkCtx=bindingStore[linkCtx[1]]){linkCtxs.push(linkCtx.linkCtx.tag)}}return linkCtxs};$sub._gccb=function(view){return function(path,object,depth){var tokens,tag,items,helper,last,nextPath,l,obsCtxPrm,addedTagCpDep,key,bindTo;if(view&&path){if(path._cpfn){return path._cpfn.call(view.tmpl,object,view,$sub)}if(path.charAt(0)==="~"){if(path.slice(0,4)==="~tag"){tag=view.ctx;if(path.charAt(4)==="."){tokens=path.slice(5).split(".");tag=tag.tag}if(tokens){return tag?[tag,tokens.join("."),object]:[]}}path=path.slice(1).split(".");if(helper=view.ctxPrm(last=path.shift(),undefined,true)){if(obsCtxPrm=helper._cxp){if(path.length){nextPath="."+path.join(".");last=helper[l=helper.length-1];if(last._cpfn){last.sb=nextPath;last.bnd=!!depth}else{helper[l]=(last+nextPath).replace("#data.","");if(last.slice(0,5)==="#view"){helper[l]=helper[l].slice(6);helper.splice(l,0,view)}}}items=[helper];if((tag=obsCtxPrm.tag)&&tag.convert){bindTo=tag.bindTo||[0];l=bindTo.length;while(l--){if(depth!==undefined&&l!==obsCtxPrm.ind){key=bindTo[l];addedTagCpDep=[helper[0],tag.tagCtx.params[+key===key?"args":"props"]];addedTagCpDep._cxp=obsCtxPrm;items.push(addedTagCpDep)}}}}else if(path.length||$isFunction(helper)){items=[helper,path.join("."),object]}}return items||[]}if(path.charAt(0)==="#"){return path==="#data"?[]:[view,path.replace(rViewPath,""),object]}}}};$sub._cp=function(paramVal,paramExpr,view,tagCtxPrm){if(view.linked){if(paramExpr){var params=delimOpenChar1+":"+paramExpr+delimCloseChar0,links=topView.tmpl.links,linkFn=links[params];if(!linkFn){links[params]=linkFn=$sub.tmplFn(params,view.tmpl,true)}paramVal=linkFn.deps[0]?[view,linkFn]:[{_ocp:tagCtxPrm?tagCtxPrm.tag.cvtArgs(true,tagCtxPrm.tagElse)[tagCtxPrm.ind]:linkFn()}]}else{paramVal=[{_ocp:undefined}]}paramVal._cxp=tagCtxPrm||{updateValue:function(val){$observable(paramVal._cxp.data).setProperty(paramVal._cxp.path,val);return this}}}return paramVal};$sub._crcp=function(key,res,storeView,store){(store||(storeView._ocps=storeView._ocps||{}))[key]=res=[{_ocp:res,_vw:storeView}];res._cxp={path:_ocp,ind:0,updateValue:function(val,path){$.observable(res[0]).setProperty(_ocp,val);return this}};return res};$sub._ucp=function(key,value,view,obsCtxPrm){var index,tag;if(!obsCtxPrm.path){resolveDataTargetPath("~"+key,view.data,$sub._gccb(view))}if(tag=obsCtxPrm.tag){index=$.inArray(key,tag.linkedCtxParam);tag.setValue(value,index,obsCtxPrm.tagElse)}return(tag||obsCtxPrm).updateValue(value,index,obsCtxPrm.tagElse)};$sub._ceo=function cloneExprObjects(obs){var ob,clones=[],l=obs.length;while(l--){ob=obs[l];if(ob._cpfn){ob=$extend({},ob);ob.prm=cloneExprObjects(ob.prm)}clones.unshift(ob)}return clones};oldAdvSet=$sub.advSet;$sub.advSet=function(){oldAdvSet.call($sub);global._jsv=$subSettingsAdvanced._jsv?$extend(global._jsv||{},{views:viewStore,bindings:bindingStore}):undefined;$viewsLinkAttr=$subSettingsAdvanced.linkAttr;linkViewsSel=bindElsSel+",["+$viewsLinkAttr+"]";wrapMap=$subSettingsAdvanced._wm;wrapMap.optgroup=wrapMap.option;wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead;wrapMap.th=wrapMap.td};$viewsSettings.advanced({linkAttr:"data-link",useViews:false,noValidate:false,_wm:{option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],svg_ns:[1,"<svg>","</svg>"],div:$.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},_fe:{input:{from:inputAttrib,to:VALUE},textarea:valueBinding,select:valueBinding,optgroup:{to:"label"}}});return $},window);