#!/usr/bin/perl
# See bottom of file for license and copyright information

# Generates module used by configure to validate URL paths.
#
# usage:
#  resources/img2perl rsources/foo.png ImageTest.pm
#
#  use '-' (or default) for stdin or stdout as usual;
#
# file type of input is used as http's Content-Type image/<type>
# png is assumed for stdin (or input files without a type).

use warnings;
use strict;

use MIME::Base64;

my $ifile = shift || '-';
my $ofile = shift || '-';

open( my $ifh, "< $ifile" )
  or die "Can't open $ifile for input: $!\n";
binmode $ifh;

my ($type) = $ifile =~ /\.(\w+)$/;
$type ||= 'png';
$type = "image/$type";

local $/;
my $data = <$ifh>;
close $ifh or die "Close failed for $ifile: $!\n";
die "No data in $ifile\n" unless ( length $data );

open( my $ofh, "> $ofile" )
  or die "Can't open $ofile for output: $!\n";

print $ofh (<< "IMAGE_MODULE");
#!/usr/bin/perl -T

# See bottom of file for license and copyright information

package Foswiki::Configure::ImageTest;

use warnings;
use strict;

use CGI ();
use CGI::Session;
use File::Temp;
use MIME::Base64;

use Foswiki::Configure qw/:session/;

\#<<<
IMAGE_MODULE

print $ofh ( "
# This module was machine-generated by $0 from $ifile "
      . scalar( localtime(time) ) . "
# The base64 content is binary data.
#
# Do not edit this file; edit the generator program instead.
#
# Every request that goes thru Foswiki::Engine ends up in Foswik::UI::handleRequest.
# If a request's query includes 'configurationTest', this module is called to respond.
#
# This mechanism allows configure to test the path thru the webserver to the request
# dispatcher.  We respond with a small image.  If the image appears, the path is clear,
# and any issues can be addressed without worrying about basic server configuration.
#
# A text diagnostic is also provided to assist with debugging webserver rewrite rules,
# for those webservers that provide apache-style SCRIPT_NAME and SCRIPT_URI values.

" . '
my @headers = ( "Cache-Control" => "no-cache", -expires => "-1d" );

sub text {
    my( $req, $res, $code, $ctext ) = splice( @_, 0 , 4 );

    my $text = join( "", @_ );

    if( $code == 200 ) {
        $res->header( -type => "text/plain", -status => "$code", @headers );
        $res->print($text);
        return $res;
    }
    $res->header( -type => "text/html", -status => "$code", @headers );
    my $html = CGI::start_html( "$code $ctext" );
    $html .= CGI::h1( {}, "$ctext" );
    $html .= CGI::p( {}, $text );
    $html .= CGI::end_html();
    $res->print($html);
    return $res;
}

sub encode {
    my $value = shift;

     if( defined $value ) {
         $value =~ s/([%\\n|])/sprintf "%%%02x", ord $1/egms;
     } else {
         $value = \'%uu\';
     }
    return $value;
}

sub respond {
    my $req = shift;

    my $res = Foswiki::Response->new;

    # Matches Configure::Dispatch

    my $sid = $req->cookie(COOKIENAME) || undef;
    if ( defined $sid && $sid =~ m/^([\w_-]+)$/ ) {
        $sid = $1;
    }
    else {
        return text($req, $res, 403, "Forbidden", "Not authorized by configure");
    }
    my $session =
      CGI::Session->load( SESSION_DSN, $sid,
        { Directory => File::Spec->tmpdir } )
      or die CGI::Session->errstr();

    unless( $req->auth_type
        || ( !$session->is_expired && !$session->is_new
             && ($session->param("_RES_OK") || $session->param("_PASSWD_OK")) ) ) {
        return text($req, $res, 403, "Forbidden", "Expired or no session");
    }

    # Respond with embedded image

    my $pinfo = $req->pathInfo;
    unless( $pinfo && $pinfo =~ m,^/Web/Topic/(Img|Env)/(\w+), ) {
        return text( $req, $res, 403, "Forbidden", "Incorrect path info " . ($pinfo || "none") );
    }

    if( $1 eq "Env" ) {
        my $txt =  join( \'|\',
                         ($ENV{SCRIPT_NAME} || \'\'),
                         ($ENV{SCRIPT_URI}  || \'\'),
                         ($2 || \'\'),
                       ) . "\\n";

        my @cgivars = ( # CGI \'Standard\'
                        qw/AUTH_TYPE CONTENT_LENGTH CONTENT_TYPE GATEWAY_INTERFACE PATH_INFO/,
                        qw/PATH_TRANSLATED QUERY_STRING REMOTE_ADDR REMOTE_HOST REMOTE_IDENT/,
                        qw/REMOTE_USER REQUEST_METHOD SCRIPT_NAME SERVER_NAME SERVER_PORT/,
                        qw/SERVER_PROTOCOL SERVER_SOFTWARE/,
                        # Apache/common extensions
                        qw/DOCUMENT_ROOT PATH_TRANSLATED REQUEST_URI SCRIPT_FILENAME/,
                        qw/SCRIPT_URI SCRIPT_URL SERVER_ADDR SERVER_ADMIN SERVER_SIGNATURE/,
                        # HTTP headers & SSL data
                        grep( /^(?:HTTP|SSL)_/, keys %ENV ),
                        # Other
                        qw/PATH MOD_PERL MOD_PERL_API_VERSION/,
                      );

        foreach my $var (sort @cgivars) {
            next unless( exists $ENV{$var} );
            $txt .= "0$var|" . encode( $ENV{$var} ) . "\n";
        }

        $txt .= \'1@INC|\' . join( \'|\', map { encode( $_ ) } @INC ) . "\n";
        my $gid = \'\';
        eval {
            $gid = join( \',\', map { lc getgrgid($_) } split( \' \', $( ) );
        };
        if( $@ ) {
            $gid = lc( qx(sh -c \'( id -un ; id -gn) 2>/dev/null\' 2>nul ));
        }
        $txt .= "1groups|" . encode( $gid ) . "\n";

        $txt .= "1uid|" . encode(eval { getlogin() || getpwuid($>) } || \'\') . "\n";
        $txt .= sprintf( "1umask|%03o\n", umask );

        return text( $req, $res, 200, "OK", $txt );
    }
' . "
   \$res->header( -type => '$type', -status => '200', \@headers );
   \$res->print(decode_base64( '
" . encode_base64($data) . "' ));
    return \$res;
}
1;
\#>>>
" );
print $ofh (
    "__END__
"
);
print $ofh (<DATA>);
close $ofh or die "Close failed on $ofile: $!\n";
exit;

1;

__END__

Foswiki - The Free and Open Source Wiki, http://foswiki.org/

Copyright (C) 2012 Foswiki Contributors. Foswiki Contributors
are listed in the AUTHORS file in the root of this distribution.
NOTE: Please extend that file, not this notice.

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version. For
more details read LICENSE in the root of this distribution.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

As per the GPL, removal of this notice is prohibited.
